<Queries>
    <Query name="Goods">
        <![CDATA[
           select DrugsID as ID,
                -- Bar code of the goods in the batch
                BarCode,

                -- Remains of the goods in the batch
                Sum(Ost) as Ost,

                -- Name of drugs in this batch
                DrugsID->LastObj->FullName as DrugsFullName,
                DrugsID->LastObj->ShortName as DrugsShortName,

                -- Information about drugs from drugs reference
                DrugsID->LastObj->EdIzm->LastObj->FullName as UnitFullName, -- SprEdi
                DrugsID->LastObj->EdIzm->LastObj->ShortName as UnitShortName, -- SprEdi

                -- Фасовка
                DrugsID->LastObj->Fas,
                DrugsID->LastObj->MNN->LastObj->FullName as MNN, -- SprMNN
                DrugsID->LastObj->Producer->LastObj->FullName as ProducerFullName, -- SprProducer
                DrugsID->LastObj->Producer->LastObj->ShortName as ProducerShortName, -- SprProducer
                -- Кол-во в упаковке
                DrugsID->LastObj->Upak as Packaging,
                DrugsID->LastObj->TradeTech as TradeTech, -- SprTradeTech,

                -- Name of the supplier (contractor)
                DocDataID->Supplier->LastObj->FullName as SupplierFullName,
                -- Retail price
                DocDataID->CenaRozN as RetailPrice
            from PartiesGoods
 	    where 1=1
             and KprID = 1
             and DayFirst < {fn CURDATE}
             and DayLast != 99999
        group by DrugsID, DocDataID->CenaRozN, DrugsID->LastObj->Producer
        order by DrugsID
        ]]>
    </Query>
    <!--
        Выгрузка номенклатуры - Nomen
            Код
            Наименование
            Родитель
            Артикул
            Вид номенклатуры
            Единица
            Полное наименование
            Комментарий
            Услуга
            Номенклатурная группа
            Страна происхождения
            Номер ГТД
            Статья затрат
            Спецификация
            Производитель
            Импортер
            ТН ВЭД
            ОКВЭД
            ОКП
            % НДС
            Меховое изделие
            Периодичность услуги
            Код операции для раздела 7 декларации по НДС
    -->
    <Query name="Nomen">
        <![CDATA[
            select Drugs->UniqCode as ID,
                substr(coalesce(Drugs->ShortName, Drugs->FullName), 1, 100) as Name,
                Drugs->FullName as FullName,
                Drugs->EdIzm->ShortName as UnitShortName,
                Drugs->Producer->FullName as Producer,
                Drugs->TypeNal->FullName as NdsPerc,
                Drugs->EdIzm->FullName as UnitFullName,
                coalesce(Drugs->EdIzm->CodeRC, 796) as UnitCode
             FROM
                DocData
            WHERE
                Destroyed = 0
        ]]>
    </Query>

    <!--
        Накладные
        ***
        Номенклатура
        Единица
        Количество
        Цена
        Сумма
        % НДС
        НДС
        Страна происхождения
        Цена в рознице
        Сумма в рознице
        % НДС в рознице
        Комитент
    -->
    <Query name="InvoiceRow">
        <![CDATA[
            select
                substr (coalesce (Drugs->LastObj->ShortName, Drugs->LastObj->FullName), 1, 100) as ShortName,
                Drugs->LastObj->FullName,
                Quantity,
                CenaUch,
                sumCenaUch,
                Drugs->LastObj->TypeNal->LastObj->FullName as NdsPerc,
                DocData.sumCenaNDS,
                Country->ShortName as Country,
                cenaRozN,
                sumCenaRozN,
                PercSaleNDS,
                Docs->Titles->NumberOfNakl,
                Docs->Titles->CodeofSupplier->LastObj->FullName as Supplier,
                Comment
            FROM
                DocData
            WHERE
                Destroyed = 0 and FlInOut=1
                and Docs->Titles->CodeOfSupplier is not null and Docs->DocType->TableName<>100
                and Docs->DocType->TableName <> 106
        ]]>
    </Query>

    <!-- Приходы -->
    <Query name="Income">
        <![CDATA[
            SELECT
                ID,
                FlInOut,
                Docs->Titles->CodeOfSupplier as Suppl,
                Docs->DocType->TableName as Tabl,
                Docs->Status1,
                Docs->Titles->DateOfSupplier,
                Docs->Titles->CodeofSupplier->LastObj->FullName,
                Docs->Titles->NumberOfNakl,
                DateRec,
                Docs->Titles->NDok,
                sumCenaZak,
                sumCenaNDS,
                sumCenaRozN
            FROM
                DocData
            WHERE
                Destroyed = 0 and FlInOut=1
                and Docs->Titles->CodeOfSupplier is not null and Docs->DocType->TableName<>100
                and Docs->DocType->TableName <> 106
        ]]>
    </Query>

    <Query name="Vidal">
        <![CDATA[
            select * from Vidal.Product
        ]]>
    </Query>

    <Query name="Tables">
        <![CDATA[
            select * from SQLUser.TablesList
        ]]>
    </Query>

    <Query name="Sold">
        <![CDATA[
         select ID as TitleID,
            DateReg,
            Docs,
            NDok,
            NumberKKM,
            SumCenaRoz,
            SumCenaZak,
            SumDiscount,
            TimeCreate,
            TypeTables,
            ZReport,
            SumCenaRoz - SumCenaZak - SumDiscount as Profit
         from doctitles
         where FlInOut = -1 and Destroyed = 0
         order by DateReg desc
        ]]>
    </Query>

    <Query name="DocTitles" extWhere="DateReg:Date">
        <![CDATA[
         select ID as TitleID,
            DateReg,
            NumberKKM,
            SumDiscount,
            ZReport,
            SumCenaRoz,
            SumCenaZak,
            SumDiscount
         from doctitles
         where 1=1
            and FlInOut = -1 and Destroyed = 0
            <extWhere>
         order by DateReg desc
        ]]>
    </Query>

    <Query name="SoldDrugs" dependsOn="DocTitles" parameters="TitleID">
        <![CDATA[
        select
             b.DataId->Drugs->FullName as DrugFullName,
             substr(coalesce (b.DataId->Drugs->ShortName, b.DataId->Drugs->FullName), 1, 100) as DrugShortName,
             b.Kol,
             b.DataId->Docs->Titles->DateReg,
             ((b.DataID->CenaRozN*b.Kol)-b.sumDisc) as sumCenaRoz,
             b.DataId->CenaRoz - (b.DataId->CenaRoz * b.Perc / 100) as CenaRoz,
             b.Perc as DiscountPerc,
             b.TypeOpl as PaymentType, -- 15 - cash, 18 - no-cash
             b.sumDisc as discount
         from
         DocDataReal b
         where 1=1
            and FlInOut = -1
            and b.DataID->destroyed = 0
            and b.Kol < 0
        order by DataId->Docs->Titles->DateReg
        ]]>
    </Query>

    <Query name="SoldDrugsReal" dependsOn="DocTitles" parameters="TitleID">
        <![CDATA[
        select
            b.DataId->Drugs->FullName as DrugFullName,
             substr(coalesce (b.DataId->Drugs->ShortName, b.DataId->Drugs->FullName), 1, 100) as DrugShortName,
             a.Kol as Quantity,
             ((b.DataID->CenaRozN*a.Kol)-b.sumDisc) as sumCenaRoz,
             b.DataId->CenaRoz - (b.DataId->CenaRoz * b.Perc / 100) as CenaRoz,
             b.Perc as DiscountPerc,
             b.TypeOpl as PaymentType, -- 15 - cash, 18 - no-cash
             b.sumDisc as discount
        from (
            select sum( Kol) as Kol,
               coalesce(DataRealID, ID) as ID
            from DocDataReal
            where 1=1
                 and DataId->FlInOut = -1
                 and DataId->destroyed = 0
                 and DataId->Docs->Titles->ID = ?
             group by DataId->Docs->Titles->DateReg, coalesce(DataRealID, ID)
            ) a,
            DocDataReal b
         where 1=1
            and b.ID = a.ID
            --and a.Kol > 0
         order by b.DataId->Drugs->FullName
         ]]>
    </Query>

    select sum( Kol) as Kol,
    coalesce(DataRealID, ID) as ID
    from DocDataReal
    where 1=1
    and DataId->FlInOut = -1
    and DataId->destroyed = 0
    and DataId->Docs->Titles->ID = 59
    group by DataId->Docs->Titles->DateReg, coalesce(DataRealID, ID)

    <Query name="BoughtDrugs">
        <![CDATA[
        select CenaRoz, CenaRozN, sumCenaRoz, sumCenaRozN, DataID, Drugs->FullName as DrugFullName,
             Quantity, QuantityA, Received, UniqCode,
             DrugsAnalog->FullName as DrugAnalog, comment, discount, docnpp,
             listref, NumberKKM, parent->Drugs->FullName
         from DocData
         where 1=1
             and FlInOut = 1
             and destroyed = 0
        ]]>
    </Query>

    <Query name="Profit">
        <![CDATA[
         select DateReg, Docs, NDok, NumberKKM, SumCenaRoz, SumCenaZak, SumDiscount, TimeCreate, TypeTables, ZReport,
            SumCenaRoz - SumCenaZak - SumDiscount as Profit
         from doctitles
         where FlInOut = -1 and Destroyed = 0
         order by DateReg desc
        ]]>
    </Query>


    <Query name="Test">
        <![CDATA[TestQuery]]>
    </Query>
</Queries>